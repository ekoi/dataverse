<ui:composition
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:p="http://primefaces.org/ui"
    xmlns:pt="http://java.sun.com/jsf/passthrough"
    xmlns:jsf="http://xmlns.jcp.org/jsf">

    <ui:remove>
        <!-- input text start UPDATE: UI:REMOVE applied due to duplicate ID errors, left code as reference incase test scripts complain -->
        <span id="pre-input-#{dsf.datasetFieldType.name}" class="pre-input-tag"/></ui:remove>
    <c:set var="displayCV" value="#{cvManagerURL != '' and (dsfv.datasetField.datasetFieldType.name =='keywordValue' or dsfv.datasetField.datasetFieldType.name=='keywordVocabulary' or dsfv.datasetField.datasetFieldType.name=='keywordVocabularyURI')}"/>
    <p:inputText value="#{dsfv.valueForEdit}" id="inputText" pt:aria-required="#{dsf.required}"
                 styleClass="form-control #{dsfv.datasetField.datasetFieldType.name == 'title' and DatasetPage.editMode == 'CREATE'  ? 'datasetfield-title' : ''}"
                 rendered="#{!dsfv.datasetField.datasetFieldType.controlledVocabulary and !displayCV
                             and (dsfv.datasetField.datasetFieldType.fieldType == 'TEXT'
                             or dsfv.datasetField.datasetFieldType.fieldType == 'INT'
                             or dsfv.datasetField.datasetFieldType.fieldType == 'FLOAT'
                             or dsfv.datasetField.datasetFieldType.fieldType == 'URL'
                             or dsfv.datasetField.datasetFieldType.fieldType == 'DATE'
                             or dsfv.datasetField.datasetFieldType.fieldType == 'EMAIL')}"/>
    <p:watermark for="inputText" value="#{dsfv.datasetField.datasetFieldType.localeWatermark}"></p:watermark>
    <ui:fragment rendered="#{cvManagerURL != '' and dsfv.datasetField.datasetFieldType.name=='keywordVocabulary'}">
        <div id="akmi-#{valCount.index+1}-Vocabulary">
            <p:selectOneMenu value="#{dsfv.valueForEdit}" id="inputTextV" tabindex="#{block.index+1}" editable="true">
                <f:selectItems value="#{DatasetPage.cvManagerVocabs}" />
            </p:selectOneMenu>
        </div>
    </ui:fragment>
    <ui:fragment rendered="#{cvManagerURL != '' and dsfv.datasetField.datasetFieldType.name =='keywordValue' }">
        <div id="akmi-#{valCount.index+1}-Term">
            <p:inputText value="#{dsfv.valueForEdit}" id="inputTextTerm" tabindex="#{block.index+1}"
                         styleClass="form-control #{dsfv.datasetField.datasetFieldType.name == 'title' and DatasetPage.editMode == 'CREATE'  ? 'datasetfield-title' : ''}"
                         rendered="#{dsfv.datasetField.datasetFieldType.title=='Term'}"/>
        </div>
    </ui:fragment>
    <ui:fragment rendered="#{cvManagerURL != '' and dsfv.datasetField.datasetFieldType.name=='keywordVocabularyURI'}">
        <div id="akmi-#{valCount.index+1}-keywordVocabularyURI">
            <p:inputText value="#{dsfv.valueForEdit}" id="inputTextU" tabindex="#{block.index+1}"
                         styleClass="form-control #{dsfv.datasetField.datasetFieldType.name == 'title' and DatasetPage.editMode == 'CREATE'  ? 'datasetfield-title' : ''}"
                         rendered="#{dsfv.datasetField.datasetFieldType.title=='Vocabulary URL'}"/>

        </div>
        <ui:fragment rendered="#{cvManagerURL != '' and dsfv.datasetField.datasetFieldType.title=='Vocabulary URL'}">

            <script>
                $(document).ready(function() {
                var jsonResult = {};
                    var selectedVocab = "";
                    $("#akmi-#{valCount.index+1}-Vocabulary").find("select[name*='inputTextV_input']").change(function(){
                        selectedVocab = $(this).children("option:selected").val();
                        $("#akmi-#{valCount.index+1}-keywordVocabularyURI").find("input[name*='inputTextU']").val("");
                        $("#akmi-#{valCount.index+1}-Term").find("input[name*='inputTextTerm']").val("");
                    });

                   $("#akmi-#{valCount.index+1}-Term").find("input[name*='inputTextTerm']").autocomplete({
                        source: function(request, response) {
                            $.ajax({
                                url: "#{cvMgrUrl}?q=" + selectedVocab,
                                dataType: "json",
                                data: { code: request.term},
                                success: function(data) {
                                    var locodes = data.listOfCodes;
                                    var terms = [];
                                    var array = [];
                                    $.each(locodes, function(i, item) {
                                        terms.push(item.prefLabel.value);
                                        array.push({
                                            term: item.prefLabel.value,
                                            url: item.url.value
                                        });
                                     });
                                    jsonResult = $.parseJSON(JSON.stringify(array));
                                    response(terms.sort());
                                }
                            });
                        },
                        minLength: 2,
                        select: function(event, ui) {
                            $.each(jsonResult, function(i, v) {
                                 if (v.term.search(new RegExp(ui.item.value)) != -1) {
                                    $("#akmi-#{valCount.index+1}-keywordVocabularyURI").find("input[name*='inputTextU']").val(v.url);
                                    return;
                                }
                            });
                         }
                    });
                 });
            </script>
            <style>
                .ui-autocomplete {
                    position: absolute;
                    cursor: default;
                    z-index: 1001 !important
                }
                 .ui-front {
                    z-index: 1500 !important;
                }
            </style>
        </ui:fragment>
    </ui:fragment>
    <p:inputTextarea value="#{dsfv.valueForEdit}" id="description" pt:aria-required="#{dsf.required}"
                     rows="5" cols="60" styleClass="form-control"
                     rendered="#{dsfv.datasetField.datasetFieldType.fieldType == 'TEXTBOX'}"/>
    <p:watermark for="description" value="#{dsfv.datasetField.datasetFieldType.localeWatermark}"></p:watermark>

    <div class="ui-message ui-message-error ui-widget ui-corner-all" aria-live="polite" jsf:rendered="#{dsfvIndex eq 0 and !empty dsfv.datasetField.validationMessage}">
        <span class="ui-message-error-detail">#{dsfv.datasetField.validationMessage}</span>
    </div>

    <div class="ui-message ui-message-error ui-widget ui-corner-all" aria-live="polite" jsf:rendered="#{!empty dsfv.validationMessage}">
        <span class="ui-message-error-detail">#{dsfv.validationMessage}</span>
    </div>

    <!-- This button / script is for replication data for the title field and is client side only -->
    <ui:fragment rendered="#{dsfv.datasetField.datasetFieldType.name == 'title' and DatasetPage.editMode == 'CREATE' }">
        <input type="button" id="replicationDataButton"
               class="btn btn-default" value="#{bundle['dataset.AddReplication']}"
               onclick="replicationFor();return false;"/>
        <script>
            //<![CDATA[
            function replicationFor() {
                $(".datasetfield-title")[0].value = "#{bundle['dataset.replicationDataFor']} " + $(".datasetfield-title")[0].value;
                $('#replicationDataButton').prop('disabled', true);
            }
            //]]>
        </script>
    </ui:fragment>

</ui:composition>